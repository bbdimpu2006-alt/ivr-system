version: "3.9"

services:

  # ──────────────────────────────────────────────────────────
  #  ASTERISK — PBX Phone Exchange
  #  Connect softphones to: sip:192.168.x.x:5060
  # ──────────────────────────────────────────────────────────
  asterisk:
    image: andrius/asterisk:20
    container_name: ivr_asterisk
    restart: always
    ports:
      - "0.0.0.0:5060:5060"    # SIP
      - "0.0.0.0:8088:8088"    # HTTP manager
    networks:
      - ivr_network
    volumes:
      - ./asterisk/conf:/etc/asterisk
      - ./asterisk/sounds:/var/lib/asterisk/sounds/custom
      - recordings:/var/spool/asterisk/monitor
      - voicemail:/var/spool/asterisk/voicemail
    environment:
      - TZ=Asia/Kolkata
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ──────────────────────────────────────────────────────────
  #  POSTGRESQL 15 — Database
  #  Connect from any device: host=192.168.x.x port=5432
  # ──────────────────────────────────────────────────────────
  postgres:
    image: postgres:15-alpine
    container_name: ivr_postgres
    restart: always
    ports:
      - "0.0.0.0:5432:5432"    # 0.0.0.0 = all network interfaces
    environment:
      POSTGRES_DB: ivr_db
      POSTGRES_USER: ivr_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ivr_secure_pass}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init:/docker-entrypoint-initdb.d
    networks:
      - ivr_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ivr_user -d ivr_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ──────────────────────────────────────────────────────────
  #  REDIS 7 — Task Queue
  #  Connect from any device: host=192.168.x.x port=6379
  # ──────────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: ivr_redis
    restart: always
    ports:
      - "0.0.0.0:6379:6379"    # 0.0.0.0 = all network interfaces
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-redis_pass}
    volumes:
      - redis_data:/data
    networks:
      - ivr_network
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-redis_pass}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ──────────────────────────────────────────────────────────
  #  FASTAPI — Admin Panel + FastAGI Server
  #  Access from any device: http://192.168.x.x:8000
  # ──────────────────────────────────────────────────────────
  fastapi:
    build:
      context: ./fastapi
      dockerfile: Dockerfile
    container_name: ivr_fastapi
    restart: always
    ports:
      - "0.0.0.0:8000:8000"    # Admin panel — all devices
      - "0.0.0.0:4573:4573"    # FastAGI — Asterisk connects here
    environment:
      - DATABASE_URL=postgresql://ivr_user:${POSTGRES_PASSWORD:-ivr_secure_pass}@postgres:5432/ivr_db
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_pass}@redis:6379/0
      - TZ=Asia/Kolkata
      - SECRET_KEY=${SECRET_KEY:-change_this_secret}
    volumes:
      - ./fastapi/app:/app/app
      - recordings:/recordings:ro
    networks:
      - ivr_network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ──────────────────────────────────────────────────────────
  #  CELERY — Background Task Worker
  # ──────────────────────────────────────────────────────────
  celery_worker:
    build:
      context: ./fastapi
      dockerfile: Dockerfile
    container_name: ivr_celery
    restart: always
    command: celery -A app.celery_app worker --loglevel=info
    environment:
      - DATABASE_URL=postgresql://ivr_user:${POSTGRES_PASSWORD:-ivr_secure_pass}@postgres:5432/ivr_db
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_pass}@redis:6379/0
      - TZ=Asia/Kolkata
    volumes:
      - ./fastapi/app:/app/app
    networks:
      - ivr_network
    depends_on:
      - redis
      - postgres

  # ──────────────────────────────────────────────────────────
  #  NGINX — Reverse Proxy
  #  HTTP  → http://192.168.x.x:80
  #  HTTPS → https://192.168.x.x:443
  # ──────────────────────────────────────────────────────────
  nginx:
    image: nginx:alpine
    container_name: ivr_nginx
    restart: always
    ports:
      - "0.0.0.0:80:80"        # All devices on network
      - "0.0.0.0:443:443"      # All devices on network (HTTPS)
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    networks:
      - ivr_network
    depends_on:
      - fastapi

# ============================================================
#  VOLUMES — Data persists across restarts
# ============================================================
volumes:
  postgres_data:
  redis_data:
  recordings:
  voicemail:

# ============================================================
#  NETWORK — Internal container communication
#  Note: Asterisk uses host networking (network_mode: host)
#        so it is NOT on this network — it talks via localhost
# ============================================================
networks:
  ivr_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16   # Fixed subnet — predictable IPs

